<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ============================================ -->
    <!-- INHERIT hr.appraisal FORM VIEW -->
    <!-- Add Badge ID, Template Selection, Criteria Lines, Scoring -->
    <!-- ============================================ -->
    <record id="view_hr_appraisal_form_inherit_template" model="ir.ui.view">
        <field name="name">hr.appraisal.form.inherit.template.selection</field>
        <field name="model">hr.appraisal</field>
        <field name="inherit_id" ref="oh_appraisal.hr_appraisal_view_form"/>
        <field name="arch" type="xml">
            
            <!-- Show Plan tab only for Survey type appraisals -->
            <xpath expr="//notebook/page[2]" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False)</attribute>
                <attribute name="string">Survey Plan</attribute>
            </xpath>
            <!-- Hide the original "Start Appraisal And Send Forms" button (we have our own) -->
            <xpath expr="//button[@name='action_start_appraisal']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            
            <!-- Add Badge ID field BEFORE employee_id label -->
            <xpath expr="//label[@for='employee_id']" position="before">
                <label for="employee_badge_id" string="Employee Badge ID"/>
                <h2>
                    <field name="employee_badge_id" 
                           placeholder="Type Badge ID or Name..."
                           class="oe_inline"
                           options="{'no_create': True, 'no_create_edit': True, 'no_open': True}"
                           context="{'search_default_name': True}"/>
                </h2>
            </xpath>
            
            <!-- Add Smart Buttons in button_box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                
                <!-- Related Appraisals Smart Button -->
                <button name="action_view_related_appraisals" 
                        type="object" 
                        class="oe_stat_button" 
                        icon="fa-link"
                        invisible="not has_related_appraisals">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Related Appraisals</span>
                    </div>
                </button>
                
                <button name="action_open_spreadsheet" 
                        type="object" 
                        class="oe_stat_button" 
                        icon="fa-table"
                        invisible="not spreadsheet_id">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Spreadsheet</span>
                    </div>
                </button>
                
                <button name="action_print_appraisal_report" 
                        type="object" 
                        class="oe_stat_button" 
                        icon="fa-file-pdf-o"
                        invisible="not criteria_loaded or appraisal_template_type == 'survey'">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Print Report</span>
                    </div>
                </button>
            </xpath>
            
            <!-- Add Template Configuration and Criteria inside notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="Assessment Template" name="assessment_template">
                    <!-- Hidden fields for domain computation -->
                    <field name="employee_team_ids" invisible="1"/>
                    <field name="available_okr_template_ids" invisible="1"/>
                    <field name="available_ninebox_template_ids" invisible="1"/>
                    <field name="has_okr_templates" invisible="1"/>
                    <field name="has_ninebox_templates" invisible="1"/>
                    <field name="criteria_loaded" invisible="1"/>
                    <field name="okr_criteria_loaded" invisible="1"/>
                    <field name="ninebox_criteria_loaded" invisible="1"/>
                    
                    <!-- Hidden helper fields for line type existence -->
                    <field name="has_dept_okr" invisible="1"/>
                    <field name="has_role_okr" invisible="1"/>
                    <field name="has_common_okr" invisible="1"/>
                    <field name="has_dept_performance" invisible="1"/>
                    <field name="has_role_performance" invisible="1"/>
                    <field name="has_common_performance" invisible="1"/>
                    <field name="has_dept_potential" invisible="1"/>
                    <field name="has_role_potential" invisible="1"/>
                    <field name="has_common_potential" invisible="1"/>
                    
                    <group string="&#x1F4CB; Assessment Template Configuration" name="template_config">
                        <!-- Warning when trying to switch after loading -->
                        <group colspan="2" invisible="not criteria_loaded">
                            <div class="alert alert-warning" role="alert">
                                <i class="fa fa-exclamation-triangle"/> 
                                <strong>Note:</strong> Criteria has been loaded for this appraisal. 
                                To create a different type of appraisal, please save this record and create a new one.
                            </div>
                        </group>
                        
                        <!-- Show related appraisals if any -->
                        <group colspan="2" invisible="not has_related_appraisals">
                            <field name="has_related_appraisals" invisible="1"/>
                            <div class="alert alert-info" role="alert">
                                <i class="fa fa-link"/> 
                                <strong>Related Appraisals:</strong> This employee has other appraisal(s) for different assessment types.
                                <button name="action_view_related_appraisals" 
                                        type="object" 
                                        string="View Related" 
                                        class="btn-link"
                                        icon="fa-external-link"/>
                            </div>
                        </group>

                        <!-- Show employee's teams info -->
                        <group colspan="2" invisible="not employee_id">
                            <div class="alert alert-info" role="alert" invisible="not employee_team_ids">
                                <strong><i class="fa fa-users"/> Employee's Teams: </strong>
                                <field name="employee_team_ids" widget="many2many_tags" readonly="1" nolabel="1" class="d-inline"/>
                            </div>
                            <div class="alert alert-warning" role="alert" invisible="employee_team_ids">
                                <i class="fa fa-exclamation-triangle"/> 
                                <strong>Warning:</strong> This employee is not assigned to any team.
                            </div>
                        </group>
                        
                        <!-- No templates message (only for OKR/9-Box) -->
                        <group colspan="2" invisible="not no_templates_message or appraisal_template_type == 'survey'">
                            <div class="alert alert-warning" role="alert">
                                <i class="fa fa-info-circle"/> 
                                <field name="no_templates_message" nolabel="1" readonly="1"/>
                            </div>
                        </group>
                        
                        <group colspan="2">
                            <field name="appraisal_template_type" 
                                   widget="radio" 
                                   options="{'horizontal': true}"
                                   readonly="criteria_loaded"/>
                        </group>
                        
                        <!-- Survey Form Selection -->
                        <group colspan="2" invisible="appraisal_template_type != 'survey'">
                            <field name="survey_id" 
                                   options="{'no_create': True, 'no_edit': True}"
                                   placeholder="Select a survey form..."
                                   required="appraisal_template_type == 'survey'"/>
                            
                            <!-- Start Appraisal button for Survey mode -->
                            <div class="mt-2">
                                <button name="action_start_appraisal"
                                        string="Start Appraisal"
                                        type="object"
                                        class="btn-primary btn-lg"
                                        icon="fa-play"
                                        invisible="check_sent == True or check_done == True or check_cancel == True"
                                        help="Start the appraisal process and send survey forms"/>
                            </div>
                        </group>
                        
                        <!-- OKR Template Selection -->
                        <group invisible="appraisal_template_type != 'okr'">
                            <label for="okr_template_id" string="Select OKR Template"/>
                            <div class="o_row">
                                <field name="okr_template_id" 
                                       options="{'no_create': True, 'no_edit': True}"
                                       class="oe_inline"
                                       nolabel="1"
                                       placeholder="Select OKR Template..."/>
                                <button name="action_open_okr_template" 
                                        type="object" 
                                        class="btn-link px-1" 
                                        icon="fa-external-link"
                                        title="Open OKR Template"
                                        invisible="not okr_template_id"/>
                            </div>
                        </group>
                        
                        <!-- 9-Box Template Selection -->
                        <group invisible="appraisal_template_type != 'ninebox'">
                            <label for="ninebox_template_id" string="Select 9-Box Template"/>
                            <div class="o_row">
                                <field name="ninebox_template_id" 
                                       options="{'no_create': True, 'no_edit': True}"
                                       class="oe_inline"
                                       nolabel="1"
                                       placeholder="Select 9-Box Template..."/>
                                <button name="action_open_ninebox_template" 
                                        type="object" 
                                        class="btn-link px-1" 
                                        icon="fa-external-link"
                                        title="Open 9-Box Template"
                                        invisible="not ninebox_template_id"/>
                            </div>
                        </group>
                        
                        <!-- Evaluation Type Selection - Many2many (only for OKR/9-Box) -->
                        <group colspan="2" invisible="appraisal_template_type == 'survey' or (not okr_template_id and not ninebox_template_id)">
                            <field name="evaluation_type_ids" widget="many2many_tags"
                                   options="{'color_field': 'sequence', 'no_create': True}"
                                   required="appraisal_template_type in ('okr', 'ninebox')"
                                   placeholder="Select evaluation types..."/>
                        </group>
                        
                        <!-- Display selected types -->
                        <group colspan="2" invisible="not evaluation_types_display">
                            <div class="alert alert-info">
                                <strong><i class="fa fa-check-circle"/> Selected Evaluations: </strong>
                                <field name="evaluation_types_display" nolabel="1" readonly="1" class="d-inline"/>
                            </div>
                        </group>
                        
                        <!-- Selected Template Display -->
                        <group colspan="2" invisible="appraisal_template_type == 'survey'">
                            <field name="selected_template_display" readonly="1" 
                                   string="Selected Template"
                                   class="text-primary fw-bold"/>
                        </group>
                        
                        <!-- Action Buttons (only for OKR/9-Box) -->
                        <group colspan="2" invisible="appraisal_template_type == 'survey' or (not okr_template_id and not ninebox_template_id) or not evaluation_type_ids">
                            <div class="mb-3">
                                <button name="action_load_criteria" 
                                        type="object" 
                                        string="Start Appraisal" 
                                        class="btn-primary btn-lg me-2"
                                        icon="fa-play"
                                        invisible="criteria_loaded"
                                        help="Load criteria from selected template"/>
                                
                                <button name="action_generate_spreadsheet" 
                                        type="object" 
                                        string="&#x1F4CA; Generate Spreadsheet"
                                        class="btn-success btn-lg me-2"
                                        icon="fa-table"
                                        invisible="not criteria_loaded or spreadsheet_id"
                                        help="Create OCA Spreadsheet for editing"/>
                                
                                <button name="action_open_spreadsheet" 
                                        type="object" 
                                        string="&#x1F4C4; Open Spreadsheet"
                                        class="btn-info btn-lg me-2"
                                        icon="fa-external-link"
                                        invisible="not spreadsheet_id"
                                        help="Open existing spreadsheet"/>
                                
                                <button name="action_refresh_spreadsheet" 
                                        type="object" 
                                        string="&#x1F504; Refresh Spreadsheet Data"
                                        class="btn-warning btn-lg"
                                        icon="fa-refresh"
                                        invisible="not spreadsheet_id"
                                        help="Sync data between criteria tables and spreadsheet"/>
                            </div>
                        </group>
                        
                        <!-- Success message when loaded (only for OKR/9-Box) -->
                        <group colspan="2" invisible="not criteria_loaded or appraisal_template_type == 'survey'">
                            <div class="alert alert-success" role="alert">
                                <i class="fa fa-check-circle"/> 
                                <strong>Criteria loaded successfully!</strong> 
                                Edit actual values below or generate a spreadsheet.
                            </div>
                        </group>
                    </group>
                    
                    <!-- OKR Criteria Tables - Separated by Type -->
                    <div invisible="appraisal_template_type != 'okr' or not criteria_loaded">
                        <!-- Overall Score -->
                        <group>
                            <group colspan="2">
                                <field name="total_okr_score" readonly="1" string="Total OKR Score"
                                       widget="progressbar" 
                                       options="{'max_value': 100}"/>
                            </group>
                        </group>
                        
                        <!-- Department Criteria Table -->
                        <group string="&#x1F3E2; Department Criteria" invisible="not has_dept_okr">
                            <field name="okr_dept_line_ids" nolabel="1" colspan="2">
                                <list editable="bottom" 
                                      decoration-success="achievement_percentage >= 100"
                                      decoration-info="achievement_percentage >= 90 and achievement_percentage &lt; 100"
                                      decoration-warning="achievement_percentage >= 70 and achievement_percentage &lt; 90"
                                      decoration-danger="achievement_percentage &lt; 70"
                                      delete="0" create="0">
                                    <field name="sequence" widget="handle"/>
                                    <field name="objective_breakdown" readonly="1" width="200px"/>
                                    <field name="priority" readonly="1" width="80px"/>
                                    <field name="team_id" readonly="1" string="Team" width="100px"/>
                                    <field name="metric" readonly="1" width="90px"/>
                                    <field name="actual_value" string="Actual" width="80px"/>
                                    <field name="target_value" readonly="1" string="Target" width="80px"/>
                                    <field name="achievement_percentage" string="Achievement %" width="120px"/>
                                    <field name="weightage" readonly="1" string="Distributed Weightage" width="160px"/>
                                    <field name="line_type" column_invisible="1"/>
                                </list>
                            </field>
                        </group>
                        
                        <!-- Role Criteria Table -->
                        <group string="&#x1F464; Role Criteria" invisible="not has_role_okr">
                            <field name="okr_role_line_ids" nolabel="1" colspan="2">
                                <list editable="bottom" 
                                      decoration-success="achievement_percentage >= 100"
                                      decoration-info="achievement_percentage >= 90 and achievement_percentage &lt; 100"
                                      decoration-warning="achievement_percentage >= 70 and achievement_percentage &lt; 90"
                                      decoration-danger="achievement_percentage &lt; 70"
                                      delete="0" create="0">
                                    <field name="sequence" widget="handle"/>
                                    <field name="objective_breakdown" readonly="1" width="200px"/>
                                    <field name="priority" readonly="1" width="80px"/>
                                    <field name="team_id" readonly="1" string="Team" width="100px"/>
                                    <field name="metric" readonly="1" width="90px"/>
                                    <field name="actual_value" string="Actual" width="80px"/>
                                    <field name="target_value" readonly="1" string="Target" width="80px"/>
                                    <field name="achievement_percentage" string="Achievement %" width="120px"/>
                                    <field name="weightage" readonly="1" string="Distributed Weightage" width="160px"/>
                                    <field name="line_type" column_invisible="1"/>
                                </list>
                            </field>
                        </group>
                        
                        <!-- Common Criteria Table -->
                        <group string="&#x1F30D; Common Criteria" invisible="not has_common_okr">
                            <field name="okr_common_line_ids" nolabel="1" colspan="2">
                                <list editable="bottom" 
                                      decoration-success="achievement_percentage >= 100"
                                      decoration-info="achievement_percentage >= 90 and achievement_percentage &lt; 100"
                                      decoration-warning="achievement_percentage >= 70 and achievement_percentage &lt; 90"
                                      decoration-danger="achievement_percentage &lt; 70"
                                      delete="0" create="0">
                                    <field name="sequence" widget="handle"/>
                                    <field name="objective_breakdown" readonly="1" width="200px"/>
                                    <field name="priority" readonly="1" width="80px"/>
                                    <field name="team_id" readonly="1" string="Team" width="100px"/>
                                    <field name="metric" readonly="1" width="90px"/>
                                    <field name="actual_value" string="Actual" width="80px"/>
                                    <field name="target_value" readonly="1" string="Target" width="80px"/>
                                    <field name="achievement_percentage" string="Achievement %" width="120px"/>
                                    <field name="weightage" readonly="1" string="Distributed Weightage" width="160px"/>
                                    <field name="line_type" column_invisible="1"/>
                                </list>
                            </field>
                        </group>
                    </div>
                    
                    <!-- 9-Box Performance Criteria Tables - Separated by Type -->
                    <div invisible="appraisal_template_type != 'ninebox' or not criteria_loaded">
                        <!-- Overall Performance Score -->
                        <group>
                            <group colspan="2">
                                <field name="total_performance_score" readonly="1" string="Total Performance Score"
                                       widget="progressbar" 
                                       options="{'max_value': 100}"/>
                            </group>
                        </group>
                        
                        <!-- Department Performance Table -->
                        <group string="&#x1F3E2; Department Performance Criteria" invisible="not has_dept_performance">
                            <field name="ninebox_perf_dept_line_ids" nolabel="1" colspan="2">
                                <list editable="bottom" 
                                      decoration-success="achievement_percentage >= 100"
                                      decoration-info="achievement_percentage >= 90 and achievement_percentage &lt; 100"
                                      decoration-warning="achievement_percentage >= 70 and achievement_percentage &lt; 90"
                                      decoration-danger="achievement_percentage &lt; 70"
                                      delete="0" create="0">
                                    <field name="sequence" widget="handle"/>
                                    <field name="objective_breakdown" readonly="1" width="200px"/>
                                    <field name="priority" readonly="1" width="80px"/>
                                    <field name="team_id" readonly="1" string="Team" width="100px"/>
                                    <field name="metric" readonly="1" width="90px"/>
                                    <field name="actual_value" string="Actual" width="80px"/>
                                    <field name="target_value" readonly="1" string="Target" width="80px"/>
                                    <field name="achievement_percentage" string="Achievement %" width="120px"/>
                                    <field name="weightage" readonly="1" string="Distributed Weightage" width="160px"/>
                                    <field name="line_type" column_invisible="1"/>
                                </list>
                            </field>
                        </group>
                        
                        <!-- Role Performance Table -->
                        <group string="&#x1F464; Role Performance Criteria" invisible="not has_role_performance">
                            <field name="ninebox_perf_role_line_ids" nolabel="1" colspan="2">
                                <list editable="bottom" 
                                      decoration-success="achievement_percentage >= 100"
                                      decoration-info="achievement_percentage >= 90 and achievement_percentage &lt; 100"
                                      decoration-warning="achievement_percentage >= 70 and achievement_percentage &lt; 90"
                                      decoration-danger="achievement_percentage &lt; 70"
                                      delete="0" create="0">
                                    <field name="sequence" widget="handle"/>
                                    <field name="objective_breakdown" readonly="1" width="200px"/>
                                    <field name="priority" readonly="1" width="80px"/>
                                    <field name="team_id" readonly="1" string="Team" width="100px"/>
                                    <field name="metric" readonly="1" width="90px"/>
                                    <field name="actual_value" string="Actual" width="80px"/>
                                    <field name="target_value" readonly="1" string="Target" width="80px"/>
                                    <field name="achievement_percentage" string="Achievement %" width="120px"/>
                                    <field name="weightage" readonly="1" string="Distributed Weightage" width="160px"/>
                                    <field name="line_type" column_invisible="1"/>
                                </list>
                            </field>
                        </group>
                        
                        <!-- Common Performance Table -->
                        <group string="&#x1F30D; Common Performance Criteria" invisible="not has_common_performance">
                            <field name="ninebox_perf_common_line_ids" nolabel="1" colspan="2">
                                <list editable="bottom" 
                                      decoration-success="achievement_percentage >= 100"
                                      decoration-info="achievement_percentage >= 90 and achievement_percentage &lt; 100"
                                      decoration-warning="achievement_percentage >= 70 and achievement_percentage &lt; 90"
                                      decoration-danger="achievement_percentage &lt; 70"
                                      delete="0" create="0">
                                    <field name="sequence" widget="handle"/>
                                    <field name="objective_breakdown" readonly="1" width="200px"/>
                                    <field name="priority" readonly="1" width="80px"/>
                                    <field name="team_id" readonly="1" string="Team" width="100px"/>
                                    <field name="metric" readonly="1" width="90px"/>
                                    <field name="actual_value" string="Actual" width="80px"/>
                                    <field name="target_value" readonly="1" string="Target" width="80px"/>
                                    <field name="achievement_percentage" string="Achievement %" width="120px"/>
                                    <field name="weightage" readonly="1" string="Distributed Weightage" width="160px"/>
                                    <field name="line_type" column_invisible="1"/>
                                </list>
                            </field>
                        </group>
                        
                        <!-- Separator -->
                        <separator string="Potential Criteria" colspan="2"/>
                        
                        <!-- Overall Potential Score -->
                        <group>
                            <group colspan="2">
                                <field name="total_potential_score" readonly="1" string="Total Potential Score"
                                       widget="progressbar" 
                                       options="{'max_value': 100}"/>
                            </group>
                        </group>
                        
                        <!-- Department Potential Table -->
                        <group string="&#x1F3E2; Department Potential Criteria" invisible="not has_dept_potential">
                            <field name="ninebox_pot_dept_line_ids" nolabel="1" colspan="2">
                                <list editable="bottom" 
                                      decoration-success="achievement_percentage >= 100"
                                      decoration-info="achievement_percentage >= 90 and achievement_percentage &lt; 100"
                                      decoration-warning="achievement_percentage >= 70 and achievement_percentage &lt; 90"
                                      decoration-danger="achievement_percentage &lt; 70"
                                      delete="0" create="0">
                                    <field name="sequence" widget="handle"/>
                                    <field name="objective_breakdown" readonly="1" width="200px"/>
                                    <field name="priority" readonly="1" width="80px"/>
                                    <field name="team_id" readonly="1" string="Team" width="100px"/>
                                    <field name="metric" readonly="1" width="90px"/>
                                    <field name="actual_value" string="Actual" width="80px"/>
                                    <field name="target_value" readonly="1" string="Target" width="80px"/>
                                    <field name="achievement_percentage" string="Achievement %" width="120px"/>
                                    <field name="weightage" readonly="1" string="Distributed Weightage" width="160px"/>
                                    <field name="line_type" column_invisible="1"/>
                                </list>
                            </field>
                        </group>
                        
                        <!-- Role Potential Table -->
                        <group string="&#x1F464; Role Potential Criteria" invisible="not has_role_potential">
                            <field name="ninebox_pot_role_line_ids" nolabel="1" colspan="2">
                                <list editable="bottom" 
                                      decoration-success="achievement_percentage >= 100"
                                      decoration-info="achievement_percentage >= 90 and achievement_percentage &lt; 100"
                                      decoration-warning="achievement_percentage >= 70 and achievement_percentage &lt; 90"
                                      decoration-danger="achievement_percentage &lt; 70"
                                      delete="0" create="0">
                                    <field name="sequence" widget="handle"/>
                                    <field name="objective_breakdown" readonly="1" width="200px"/>
                                    <field name="priority" readonly="1" width="80px"/>
                                    <field name="team_id" readonly="1" string="Team" width="100px"/>
                                    <field name="metric" readonly="1" width="90px"/>
                                    <field name="actual_value" string="Actual" width="80px"/>
                                    <field name="target_value" readonly="1" string="Target" width="80px"/>
                                    <field name="achievement_percentage" string="Achievement %" width="120px"/>
                                    <field name="weightage" readonly="1" string="Distributed Weightage" width="160px"/>
                                    <field name="line_type" column_invisible="1"/>
                                </list>
                            </field>
                        </group>
                        
                        <!-- Common Potential Table -->
                        <group string="&#x1F30D; Common Potential Criteria" invisible="not has_common_potential">
                            <field name="ninebox_pot_common_line_ids" nolabel="1" colspan="2">
                                <list editable="bottom" 
                                      decoration-success="achievement_percentage >= 100"
                                      decoration-info="achievement_percentage >= 90 and achievement_percentage &lt; 100"
                                      decoration-warning="achievement_percentage >= 70 and achievement_percentage &lt; 90"
                                      decoration-danger="achievement_percentage &lt; 70"
                                      delete="0" create="0">
                                    <field name="sequence" widget="handle"/>
                                    <field name="objective_breakdown" readonly="1" width="200px"/>
                                    <field name="priority" readonly="1" width="80px"/>
                                    <field name="team_id" readonly="1" string="Team" width="100px"/>
                                    <field name="metric" readonly="1" width="90px"/>
                                    <field name="actual_value" string="Actual" width="80px"/>
                                    <field name="target_value" readonly="1" string="Target" width="80px"/>
                                    <field name="achievement_percentage" string="Achievement %" width="120px"/>
                                    <field name="weightage" readonly="1" string="Distributed Weightage" width="160px"/>
                                    <field name="line_type" column_invisible="1"/>
                                </list>
                            </field>
                        </group>
                    </div>
                    
                    <!-- Performance Summary Section (only for OKR/9-Box) -->
                    <group string="&#x1F3AF; Performance Summary" invisible="not criteria_loaded or appraisal_template_type == 'survey'">
                        <group colspan="2">
                            <field name="performance_chart_html" nolabel="1" readonly="1" widget="html"/>
                        </group>
                    </group>
                </page>
            </xpath>
            
            <!-- Conditionally show/hide survey fields based on template type -->
            <!-- Manager section -->
            <xpath expr="//field[@name='hr_manager']" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False) or check_draft == False</attribute>
            </xpath>
            <xpath expr="//field[@name='hr_manager_ids']" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False) or hr_manager == False</attribute>
            </xpath>
            <xpath expr="//field[@name='manager_survey_id']" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False) or hr_manager == False</attribute>
            </xpath>
            
            <!-- Employee section -->
            <xpath expr="//field[@name='hr_emp']" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False)</attribute>
            </xpath>
            <xpath expr="//field[@name='emp_survey_id']" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False) or hr_emp == False</attribute>
            </xpath>
            
            <!-- Collaborator section -->
            <xpath expr="//field[@name='hr_collaborator']" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False) or check_draft == False</attribute>
            </xpath>
            <xpath expr="//field[@name='hr_collaborator_ids']" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False) or hr_collaborator == False</attribute>
            </xpath>
            <xpath expr="//field[@name='collaborator_survey_id']" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False) or hr_collaborator == False</attribute>
            </xpath>
            
            <!-- Colleague section -->
            <xpath expr="//field[@name='hr_colleague']" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False)</attribute>
            </xpath>
            <xpath expr="//field[@name='hr_colleague_ids']" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False) or hr_colleague == False</attribute>
            </xpath>
            <xpath expr="//field[@name='colleague_survey_id']" position="attributes">
                <attribute name="invisible">appraisal_template_type not in ('survey', False) or hr_colleague == False</attribute>
            </xpath>

            <!-- Hide Appraisal Result Summary (from oh_appraisal_ext) for OKR and 9-Box types -->
            <xpath expr="//field[@name='final_percentage']/.." position="attributes">
                <attribute name="invisible">appraisal_template_type in ('okr', 'ninebox')</attribute>
            </xpath>
            
        </field>
    </record>

    <!-- Tree View Updates remain the same -->
    <record id="view_hr_appraisal_tree_inherit_template" model="ir.ui.view">
        <field name="name">hr.appraisal.tree.inherit.template</field>
        <field name="model">hr.appraisal</field>
        <field name="inherit_id" ref="oh_appraisal.hr_appraisal_view_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='employee_id']" position="before">
                <field name="employee_badge_id" optional="show" string="Badge ID"/>
            </xpath>
            <xpath expr="//field[@name='employee_id']" position="after">
                <field name="appraisal_template_type" widget="badge" 
                       decoration-info="appraisal_template_type == 'survey'"
                       decoration-success="appraisal_template_type == 'okr'"
                       decoration-warning="appraisal_template_type == 'ninebox'"
                       optional="show"
                       string="Type"/>
                <field name="selected_template_display" optional="show" string="Template"/>
                <field name="criteria_loaded" optional="hide" widget="boolean" string="Loaded"/>
                <field name="final_score" optional="show" string="Score"/>
                <field name="performance_rating" optional="show" 
                       widget="badge"
                       decoration-success="performance_rating == 'outstanding'"
                       decoration-info="performance_rating == 'exceeds'"
                       decoration-primary="performance_rating == 'meets'"
                       decoration-warning="performance_rating == 'needs_improvement'"
                       decoration-danger="performance_rating == 'unsatisfactory'"/>
            </xpath>
        </field>
    </record>

    <!-- Kanban and Search views remain the same -->
    <record id="view_hr_appraisal_kanban_inherit_template" model="ir.ui.view">
        <field name="name">hr.appraisal.kanban.inherit.template</field>
        <field name="model">hr.appraisal</field>
        <field name="inherit_id" ref="oh_appraisal.hr_appraisal_view_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//kanban/field[@name='stage_id']" position="after">
                <field name="appraisal_template_type"/>
                <field name="final_score"/>
                <field name="performance_rating"/>
            </xpath>
            
            <xpath expr="//div[@class='oe_kanban_content']/div[1]/strong" position="after">
                <div class="mt-1">
                    <span t-if="record.appraisal_template_type.raw_value == 'okr'" 
                          class="badge text-bg-success">OKR</span>
                    <span t-if="record.appraisal_template_type.raw_value == 'ninebox'" 
                          class="badge text-bg-warning">9-Box</span>
                    <span t-if="record.appraisal_template_type.raw_value == 'survey'" 
                          class="badge text-bg-info">Survey</span>
                    <span t-if="record.final_score.raw_value" class="badge text-bg-primary ms-2">
                        Score: <t t-esc="record.final_score.value"/>%
                    </span>
                </div>
            </xpath>
        </field>
    </record>

    <record id="view_hr_appraisal_search_template" model="ir.ui.view">
        <field name="name">hr.appraisal.search.template</field>
        <field name="model">hr.appraisal</field>
        <field name="arch" type="xml">
            <search string="Search Appraisals">
                <field name="employee_id"/>
                <field name="employee_badge_id" string="Badge ID"/>
                <field name="okr_template_id"/>
                <field name="ninebox_template_id"/>
                
                <separator/>
                <filter string="Survey Appraisals" 
                        name="filter_survey" 
                        domain="[('appraisal_template_type', '=', 'survey')]"/>
                <filter string="OKR Appraisals" 
                        name="filter_okr" 
                        domain="[('appraisal_template_type', '=', 'okr')]"/>
                <filter string="9-Box Appraisals" 
                        name="filter_ninebox" 
                        domain="[('appraisal_template_type', '=', 'ninebox')]"/>
                
                <separator/>
                <filter string="Criteria Loaded" 
                        name="filter_criteria_loaded"
                        domain="[('criteria_loaded', '=', True)]"/>
                <filter string="Outstanding Performance" 
                        name="filter_outstanding"
                        domain="[('performance_rating', '=', 'outstanding')]"/>
                
                <separator/>
                <filter string="My Appraisals" 
                        name="filter_my_appraisals"
                        domain="[('employee_id.user_id', '=', uid)]"/>
                
                <group expand="0" string="Group By">
                    <filter string="Employee" 
                            name="group_employee" 
                            context="{'group_by': 'employee_id'}"/>
                    <filter string="Template Type" 
                            name="group_template_type" 
                            context="{'group_by': 'appraisal_template_type'}"/>
                    <filter string="Performance Rating" 
                            name="group_rating" 
                            context="{'group_by': 'performance_rating'}"/>
                    <filter string="Stage" 
                            name="group_stage" 
                            context="{'group_by': 'stage_id'}"/>
                </group>
            </search>
        </field>
    </record>

</odoo>